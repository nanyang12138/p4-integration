{% extends "layout.html" %}
{% block content %}
<div class="max-w-2xl mx-auto">
  
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-slate-800 tracking-tight">New Integration Job</h2>
      <p class="text-sm text-slate-500 mt-1">Configure source, target, and changelist.</p>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="p-6">
      <form method="post" action="/admin/submit" class="space-y-6">
        
        <!-- P4 Configuration -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
          <div class="flex items-center justify-between">
             <h3 class="text-sm font-semibold text-blue-900">P4 Configuration</h3>
             <span class="text-xs text-blue-600">Logged in as: <strong>{{ session.get('p4_user', 'Unknown') }}</strong></span>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-blue-800 mb-1">P4 Port</label>
              <input type="text" name="p4_port" id="p4_port" class="block w-full px-3 py-1.5 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="e.g. srdcp4ps1.amd.com:1677" required>
            </div>
            <div>
              <label class="block text-xs font-medium text-blue-800 mb-1">P4 Client</label>
              <input type="text" name="p4_client" id="p4_client" class="block w-full px-3 py-1.5 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="e.g. user_workspace_name" required>
            </div>
          </div>
        </div>

        <!-- Branch Spec -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Branch Spec <span class="text-slate-400 font-normal">(Optional)</span></label>
          {% set specs = (config.get('specs', {}) if config else {}) %}
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa-solid fa-code-branch text-slate-400 text-sm"></i>
            </div>
            <input id="specInput" list="spec-suggestions" type="text" name="branch_spec" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="e.g. gfxip_unified_main_to_orion" />
          </div>
          <datalist id="spec-suggestions">
            {% for name, sp in specs.items() %}
              <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
          </datalist>
          <p class="mt-1 text-xs text-slate-500">If provided, source and target paths are not required.</p>
        </div>

        <!-- Source/Target Group -->
        <div id="srcTgtGroup" class="space-y-4 p-4 bg-slate-50 rounded-lg border border-slate-200 transition-all">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Source Path</label>
            {% set defaults = (config.get('defaults', {}) if config else {}) %}
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-folder-open text-slate-400 text-sm"></i>
              </div>
              <input type="text" name="source" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm bg-white" value="{{ defaults.get('source','') }}" placeholder="//depot/path/to/source/..." />
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Target Path</label>
            <div class="relative">
               <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fa-solid fa-bullseye text-slate-400 text-sm"></i>
              </div>
              <input type="text" name="target" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm bg-white" value="{{ defaults.get('target','') }}" placeholder="//depot/path/to/target/..." />
            </div>
          </div>
        </div>

        <!-- Changelist -->
        <div>
          <label id="clLabel" class="block text-sm font-medium text-slate-700 mb-1">Changelist</label>
          <div class="relative">
             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa-solid fa-list-ol text-slate-400 text-sm"></i>
            </div>
            <input type="text" name="changelist" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="e.g. 123456" />
          </div>
          <p id="clHelp" class="mt-2 text-xs text-slate-500 flex items-start gap-1.5">
            <i class="fa-solid fa-info-circle mt-0.5 text-primary-500"></i>
            <span>Without Branch Spec: integrates <code>p4 integ &lt;source&gt;... @&lt;changelist&gt; &lt;target&gt;...</code></span>
          </p>
        </div>

        <!-- Workspace -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Workspace <span class="text-red-500">*</span></label>
          <div class="relative">
             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa-solid fa-laptop-code text-slate-400 text-sm"></i>
            </div>
            <input type="text" name="workspace" id="workspace" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="/path/to/workspace" required />
          </div>
          <p class="mt-1 text-xs text-slate-500">Local path on the remote machine where P4 client is mapped.</p>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fa-solid fa-align-left text-slate-400 text-sm"></i>
            </div>
            <input type="text" name="description" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="Brief description of this job" />
          </div>
        </div>

        <!-- SSH/Agent Configuration (Collapsible) -->
        <details id="sshConfigSection" class="bg-amber-50 border border-amber-200 rounded-lg overflow-hidden">
          <summary class="px-4 py-3 cursor-pointer hover:bg-amber-100/50 transition-colors flex items-center gap-2 select-none">
            <i class="fa-solid fa-chevron-right text-[10px] text-amber-600 transition-transform details-chevron"></i>
            <i class="fa-solid fa-terminal text-amber-600 text-sm"></i>
            <span class="text-sm font-semibold text-amber-900">SSH / Agent Connection</span>
            <span id="sshConfigStatus" class="ml-auto text-xs text-amber-600"></span>
          </summary>
          <div class="px-4 pb-4 pt-2 space-y-4 border-t border-amber-200">
            <p class="text-xs text-amber-700">Configure how to connect to the remote machine and how the Agent connects back.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-amber-800 mb-1">SSH Host <span class="text-red-500">*</span></label>
                <input type="text" name="ssh_host" id="ssh_host" value="{{ session.get('ssh_host', '') }}" class="block w-full px-3 py-1.5 border border-amber-300 rounded-md focus:ring-amber-500 focus:border-amber-500 text-sm bg-white" placeholder="e.g. atletx8-neu006.amd.com" required>
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-800 mb-1">SSH Port</label>
                <input type="number" name="ssh_port" id="ssh_port" value="{{ session.get('ssh_port', 22) }}" class="block w-full px-3 py-1.5 border border-amber-300 rounded-md focus:ring-amber-500 focus:border-amber-500 text-sm bg-white" placeholder="22">
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-amber-800 mb-1">Master Host <span class="text-red-500">*</span></label>
                <input type="text" name="master_host" id="master_host" value="{{ session.get('master_host', '') }}" class="block w-full px-3 py-1.5 border border-amber-300 rounded-md focus:ring-amber-500 focus:border-amber-500 text-sm bg-white" placeholder="e.g. 10.67.190.37" required>
                <p class="mt-1 text-[10px] text-amber-600">IP/hostname reachable from SSH host</p>
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-800 mb-1">Master Port</label>
                <input type="number" name="master_port" id="master_port" value="{{ session.get('master_port', 9090) }}" class="block w-full px-3 py-1.5 border border-amber-300 rounded-md focus:ring-amber-500 focus:border-amber-500 text-sm bg-white" placeholder="9090">
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-amber-800 mb-1">Remote Python Path</label>
              <input type="text" name="python_path" id="python_path" value="{{ session.get('python_path', '/tool/pandora64/bin/python3.11') }}" class="block w-full px-3 py-1.5 border border-amber-300 rounded-md focus:ring-amber-500 focus:border-amber-500 text-sm bg-white" placeholder="/tool/pandora64/bin/python3.11">
            </div>
          </div>
        </details>

        <!-- Trial Mode -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" name="trial" value="true" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-slate-300 rounded">
            <span class="ml-3 flex flex-col">
              <span class="text-sm font-medium text-slate-900">Trial Run Mode</span>
              <span class="text-xs text-slate-500">Test the integration without actually pushing to server (p4push -trial)</span>
            </span>
          </label>
        </div>

        <!-- Status message area (shown during submission) -->
        <div id="submitStatusMsg" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center gap-2 text-blue-700 text-sm">
            <i class="fa-solid fa-circle-notch animate-spin"></i>
            <span id="submitStatusText">Connecting to remote machine via SSH...</span>
          </div>
          <p class="text-xs text-blue-600 mt-1">This may take up to 15 seconds. Please wait...</p>
        </div>

        <!-- Submit Button -->
        <div class="pt-4 border-t border-slate-100 flex justify-end gap-3">
          <a href="/admin" id="cancelLink" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">Cancel</a>
          <button id="btnCreate" type="submit" class="inline-flex justify-center py-2.5 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all transform active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fa-solid fa-play mr-2"></i> Start Integration
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  // Form Logic
  var spec = document.getElementById('specInput');
  var srcTgt = document.getElementById('srcTgtGroup');
  var clLabel = document.getElementById('clLabel');
  var clHelp = document.getElementById('clHelp');
  var sourceInput = document.querySelector('input[name="source"]');
  var targetInput = document.querySelector('input[name="target"]');
  
  function update(){
    var hasSpec = spec && spec.value.trim().length > 0;
    
    if (srcTgt) {
      if(hasSpec) {
        srcTgt.classList.add('opacity-50', 'pointer-events-none', 'bg-slate-100');
        srcTgt.classList.remove('bg-slate-50');
      } else {
        srcTgt.classList.remove('opacity-50', 'pointer-events-none', 'bg-slate-100');
        srcTgt.classList.add('bg-slate-50');
      }
    }
    
    if (sourceInput) sourceInput.disabled = hasSpec;
    if (targetInput) targetInput.disabled = hasSpec;
    
    if (clLabel) clLabel.textContent = hasSpec ? 'Changelist (Optional)' : 'Changelist';
    
    if (clHelp) {
       const icon = '<i class="fa-solid fa-info-circle mt-0.5 text-primary-500"></i> ';
       clHelp.innerHTML = icon + (hasSpec
        ? '<span>With Branch Spec: integrates <code>p4 integ -b &lt;spec&gt; ...@&lt;changelist&gt;</code>. Source/Target ignored.</span>'
        : '<span>Without Branch Spec: integrates <code>p4 integ &lt;source&gt;... @&lt;changelist&gt; &lt;target&gt;...</code>.</span>');
    }
  }
  
  if (spec){
    spec.addEventListener('input', update);
    update();
  }

  // LocalStorage persistence for form fields
  const fields = ['p4_port', 'p4_client', 'workspace', 'ssh_host', 'ssh_port', 'master_host', 'master_port', 'python_path'];
  const defaults = {
    'p4_port': 'atlvp4p01.amd.com:1677',
    'p4_client': '',
    'workspace': '',
    'ssh_host': '',
    'ssh_port': '22',
    'master_host': '',
    'master_port': '9090',
    'python_path': '/tool/pandora64/bin/python3.11'
  };
  
  fields.forEach(function(field) {
    const input = document.getElementById(field);
    if (input) {
      // Load from localStorage if input is empty or has no session value
      if (!input.value || input.value === '' || input.value === 'None') {
        const stored = localStorage.getItem('p4_integ_' + field);
        if (stored) {
          input.value = stored;
        } else if (defaults[field]) {
          input.value = defaults[field];
        }
      }
      
      // Save to localStorage on change
      input.addEventListener('change', function() {
        localStorage.setItem('p4_integ_' + field, this.value);
        updateSSHStatus();
      });
    }
  });

  // SSH config status indicator & auto-open
  function updateSSHStatus() {
    const sshHost = document.getElementById('ssh_host');
    const masterHost = document.getElementById('master_host');
    const statusEl = document.getElementById('sshConfigStatus');
    const section = document.getElementById('sshConfigSection');
    if (!sshHost || !masterHost || !statusEl) return;
    
    const configured = sshHost.value.trim() && masterHost.value.trim();
    statusEl.textContent = configured ? 'Configured' : 'Not configured';
    statusEl.className = 'ml-auto text-xs ' + (configured ? 'text-green-600 font-medium' : 'text-red-500 font-medium');
    
    // Auto-open if not configured
    if (!configured && section) {
      section.open = true;
    }
  }
  updateSSHStatus();

  // ========== Loading State for Form Submission ==========
  let isSubmitting = false;
  const form = document.querySelector('form[action="/admin/submit"]');
  const submitBtn = document.getElementById('btnCreate');
  const cancelLink = document.getElementById('cancelLink');
  const statusMsg = document.getElementById('submitStatusMsg');
  const statusText = document.getElementById('submitStatusText');
  
  function setFormSubmitting(loading) {
    isSubmitting = loading;
    
    if (loading) {
      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Starting...';
      
      // Disable cancel link
      cancelLink.classList.add('opacity-50', 'pointer-events-none');
      
      // Show status message
      statusMsg.classList.remove('hidden');
      
      // Disable all form inputs
      form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
    } else {
      // Re-enable everything
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fa-solid fa-play mr-2"></i> Start Integration';
      cancelLink.classList.remove('opacity-50', 'pointer-events-none');
      statusMsg.classList.add('hidden');
      form.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false);
      
      // Re-apply spec-based disabling
      update();
    }
  }
  
  if (form) {
    form.addEventListener('submit', function(e) {
      // Prevent double submission
      if (isSubmitting) {
        e.preventDefault();
        console.log('Submission already in progress, ignoring');
        return false;
      }
      
      // Show loading state immediately
      setFormSubmitting(true);
      
      // Update status message over time
      const statusUpdates = [
        { delay: 3000, text: 'Deploying agent on remote machine...' },
        { delay: 6000, text: 'Waiting for agent to connect back...' },
        { delay: 10000, text: 'Almost there, establishing connection...' }
      ];
      
      statusUpdates.forEach(update => {
        setTimeout(() => {
          if (statusText && isSubmitting) {
            statusText.textContent = update.text;
          }
        }, update.delay);
      });
      
      // Allow form to submit normally (POST)
      return true;
    });
  }
})();
</script>
{% endblock %}
