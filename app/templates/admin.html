{% extends "layout.html" %}

{% block content %}
<div class="space-y-6">
  
  <!-- Header & Stats -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-slate-900">Dashboard</h1>
      <p class="text-sm text-slate-500 mt-1">Overview of all integration jobs</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="flex gap-4">
      {% set running_count = jobs | rejectattr('stage', 'in', ['DONE', 'ERROR']) | list | length %}
      {% set done_count = jobs | selectattr('stage', 'equalto', 'DONE') | list | length %}
      {% set error_count = jobs | selectattr('stage', 'equalto', 'ERROR') | list | length %}
      
      <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
        <div>
          <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Running</div>
          <div class="text-lg font-bold text-slate-900">{{ running_count }}</div>
        </div>
      </div>
      
      <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        <div>
          <div class="text-xs text-slate-500 font-medium uppercase tracking-wider">Completed</div>
          <div class="text-lg font-bold text-slate-900">{{ done_count }}</div>
        </div>
      </div>
      
      {% if error_count > 0 %}
      <div class="bg-white px-4 py-2 rounded-lg shadow-sm border border-red-200 flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-red-500"></div>
        <div>
          <div class="text-xs text-red-500 font-medium uppercase tracking-wider">Failed</div>
          <div class="text-lg font-bold text-red-600">{{ error_count }}</div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Main Job List -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    {% if not jobs %}
    <div class="p-12 text-center">
      <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fa-solid fa-inbox text-slate-300 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-slate-900">No jobs found</h3>
      <p class="text-slate-500 mt-1 mb-6">Get started by creating your first integration job.</p>
      <a href="/admin/submit" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm shadow-primary-500/30">
        <i class="fa-solid fa-plus mr-2"></i> Create Job
      </a>
    </div>
    {% else %}
    <div class="overflow-x-auto">
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold">
            <th class="px-6 py-4 w-16">ID</th>
            <th class="px-6 py-4">Job Description</th>
            <th class="px-6 py-4">Branch / Path</th>
            <th class="px-6 py-4">Status</th>
            <th class="px-6 py-4 text-right">Last Update</th>
            <th class="px-6 py-4 text-right">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {% for job in jobs %}
          <tr class="hover:bg-slate-50/80 transition-colors group">
            <td class="px-6 py-4 font-mono text-xs text-slate-400">
              {{ job.job_id[:8] }}
            </td>
            <td class="px-6 py-4">
              <div class="font-medium text-slate-900">{{ job.spec.description or 'No description' }}</div>
              <div class="text-xs text-slate-500 mt-0.5">
                CL: 
                {% if job.source_changelist and job.source_changelist != 'latest' %}
                  {{ job.source_changelist }}
                {% elif job.spec.changelist %}
                  {{ job.spec.changelist }}
                {% else %}
                  <span class="text-amber-500 italic">fetching...</span>
                {% endif %}
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex flex-col gap-1 text-xs">
                <span class="inline-flex items-center gap-1.5 text-slate-600 bg-slate-100 px-2 py-0.5 rounded border border-slate-200 w-fit">
                  <i class="fa-solid fa-code-branch text-[10px]"></i> {{ job.spec.branch_spec }}
                </span>
                <span class="text-slate-400 truncate max-w-[200px]" title="{{ job.spec.path }}">{{ job.spec.path }}</span>
              </div>
            </td>
            <td class="px-6 py-4">
              {% set status_map = {
                'INIT': {'status': 'pending', 'color': 'bg-slate-100 text-slate-700 border-slate-200'},
                'GET_LATEST_CL': {'status': 'running', 'color': 'bg-green-100 text-green-700 border-green-200', 'animate': true},
                'SYNC': {'status': 'running', 'color': 'bg-green-100 text-green-700 border-green-200', 'animate': true},
                'INTEGRATE': {'status': 'running', 'color': 'bg-green-100 text-green-700 border-green-200', 'animate': true},
                'RESOLVE_PASS_1': {'status': 'running', 'color': 'bg-green-100 text-green-700 border-green-200', 'animate': true},
                'RESOLVE_CHECK': {'status': 'running', 'color': 'bg-green-100 text-green-700 border-green-200', 'animate': true},
                'NEEDS_RESOLVE': {'status': 'needs_resolve', 'color': 'bg-amber-100 text-amber-700 border-amber-200'},
                'PRE_SUBMIT': {'status': 'running', 'color': 'bg-blue-100 text-blue-700 border-blue-200', 'animate': true},
                'SHELVE': {'status': 'running', 'color': 'bg-blue-100 text-blue-700 border-blue-200', 'animate': true},
                'P4PUSH': {'status': 'running', 'color': 'bg-blue-100 text-blue-700 border-blue-200', 'animate': true},
                'CLEANUP': {'status': 'error', 'color': 'bg-orange-100 text-orange-700 border-orange-200', 'animate': true},
                'DONE': {'status': 'done', 'color': 'bg-green-100 text-green-700 border-green-200'},
                'ERROR': {'status': 'error', 'color': 'bg-red-100 text-red-700 border-red-200'}
              } %}
              {% set stage_info = status_map.get(job.stage, {'status': 'unknown', 'color': 'bg-slate-100 text-slate-700 border-slate-200'}) %}
              
              <div class="flex flex-col gap-1">
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border {{ stage_info.color }}">
                  {% if stage_info.animate %}
                    <span class="w-1.5 h-1.5 rounded-full bg-current mr-1.5 animate-pulse"></span>
                  {% endif %}
                  {{ stage_info.status|upper }}
                </span>
                <span class="text-[10px] text-slate-400">{{ job.stage }}</span>
              </div>
            </td>
            <td class="px-6 py-4 text-right text-slate-500 tabular-nums text-xs">
              <div class="ts" data-ts="{{ job.updated_at_ts }}">
                {{ job.updated_at }}
              </div>
            </td>
            <td class="px-6 py-4 text-right">
              <a href="/jobs/{{ job.job_id }}" class="text-primary-600 hover:text-primary-700 font-medium text-xs hover:underline group-hover:translate-x-1 transition-transform inline-block">
                View Details <i class="fa-solid fa-arrow-right ml-0.5"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</div>

<!-- Add simple timestamp parser helper if needed by template -->
<script>
  // Simple inline JS to convert ISO strings to timestamp for the relative time helper
  document.querySelectorAll('.ts').forEach(el => {
    const iso = el.textContent.trim();
    if(iso && !el.getAttribute('data-ts')) {
      const ts = Math.floor(new Date(iso).getTime() / 1000);
      if(!isNaN(ts)) el.setAttribute('data-ts', ts);
    }
  });
</script>
{% endblock %}
