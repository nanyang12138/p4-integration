{% extends "layout.html" %}
{% block content %}
{% set cfg = (config or {}) %}
{% set exec = (cfg.get('exec', {}) if cfg else {}) %}
{% set ssh = (exec.get('ssh', {}) if exec else {}) %}

<div class="max-w-3xl mx-auto space-y-6">
  
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold text-slate-800 tracking-tight">Execution Settings</h2>
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600 border border-slate-200">
      Workspace: {{ exec.get('workspace_root', cfg.get('workspace_root','')) or '-' }}
    </span>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="p-6 border-b border-slate-100">
      <h3 class="text-lg font-medium text-slate-900 flex items-center gap-2">
        <i class="fa-solid fa-sliders text-primary-500"></i> Execution Mode
      </h3>
      <p class="mt-1 text-sm text-slate-500">Choose whether to run P4 commands locally on this server or remotely via SSH.</p>
    </div>
    
    <div class="p-6 space-y-8">
      
      <!-- Mode Selection -->
      <div>
        <label class="text-sm font-medium text-slate-700 mb-3 block">Connection Type</label>
        <div class="flex flex-wrap gap-4">
          <label class="relative flex items-center p-4 rounded-lg border cursor-pointer hover:bg-slate-50 transition-all focus-within:ring-2 focus-within:ring-primary-500 w-full sm:w-auto
            {% if exec.get('mode','local') != 'ssh' %} border-primary-500 bg-primary-50/30 {% else %} border-slate-200 {% endif %}">
            <input type="radio" name="exec_mode" value="local" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-slate-300" {% if exec.get('mode','local') != 'ssh' %}checked{% endif %}/>
            <div class="ml-3">
              <span class="block text-sm font-medium text-slate-900">Local Execution</span>
              <span class="block text-xs text-slate-500">Run directly on this machine</span>
            </div>
          </label>
          
          <label class="relative flex items-center p-4 rounded-lg border cursor-pointer hover:bg-slate-50 transition-all focus-within:ring-2 focus-within:ring-primary-500 w-full sm:w-auto
            {% if exec.get('mode') == 'ssh' %} border-primary-500 bg-primary-50/30 {% else %} border-slate-200 {% endif %}">
            <input type="radio" name="exec_mode" value="ssh" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-slate-300" {% if exec.get('mode') == 'ssh' %}checked{% endif %}/>
            <div class="ml-3">
              <span class="block text-sm font-medium text-slate-900">SSH Remote</span>
              <span class="block text-xs text-slate-500">Connect to a Linux host</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Common Fields -->
      <div>
        <label for="exec_workspace_root" class="block text-sm font-medium text-slate-700 mb-1">Workspace Root Path</label>
        <div class="relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-folder text-slate-400"></i>
          </div>
          <input type="text" id="exec_workspace_root" class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-md focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="/path/to/workspace" value="{{ exec.get('workspace_root', cfg.get('workspace_root','')) }}">
        </div>
        <p class="mt-1 text-xs text-slate-500">Absolute path where the Perforce client workspace is located.</p>
      </div>

      <!-- SSH Fields -->
      <div id="sshFields" class="space-y-6 pt-6 border-t border-slate-100 hidden">
        <h4 class="text-sm font-medium text-slate-900 uppercase tracking-wider">SSH Configuration</h4>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Host</label>
            <input id="ssh_host" type="text" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="hostname or IP" value="{{ ssh.get('host','') }}"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Port</label>
            <input id="ssh_port" type="number" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="22" value="{{ ssh.get('port',22) }}"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Username</label>
            <input id="ssh_user" type="text" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="username" value="{{ ssh.get('user','') }}"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Key Path</label>
            <input id="ssh_key_path" type="text" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="~/.ssh/id_rsa" value="{{ ssh.get('key_path','') }}"/>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Password</label>
            <div class="relative">
              <input id="ssh_password" type="password" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm pr-10" placeholder="Optional if using key" value=""/>
              <button type="button" id="ssh_password_toggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-600 cursor-pointer">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Shell</label>
            <input id="ssh_shell" type="text" class="block w-full border-slate-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="/bin/bash" value="{{ ssh.get('shell','/bin/bash') }}"/>
          </div>
        </div>
        
        <div class="flex items-center">
          <input id="ssh_login_shell" type="checkbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-slate-300 rounded" {% if ssh.get('login_shell') %}checked{% endif %}/>
          <label for="ssh_login_shell" class="ml-2 block text-sm text-slate-700">Use login shell (bash -l)</label>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex items-center gap-4 pt-4 border-t border-slate-100">
        <button class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all" id="btnApplyMode" type="button">
          <i class="fa-solid fa-save mr-2"></i> Save Configuration
        </button>
        <button class="inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all" id="btnTest" type="button">
          <i class="fa-solid fa-plug mr-2"></i> Test Connection
        </button>
        <span id="testResult" class="hidden px-2.5 py-0.5 rounded-full text-xs font-medium"></span>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  var radios = document.querySelectorAll('input[name="exec_mode"]');
  var sshFields = document.getElementById('sshFields');
  
  function setVisible(){
    var checked = Array.prototype.find.call(radios, function(r){ return r.checked; });
    var mode = checked ? checked.value : 'local';
    if (sshFields) {
       if (mode === 'ssh') {
         sshFields.classList.remove('hidden');
       } else {
         sshFields.classList.add('hidden');
       }
    }
    // Update radio styling
    radios.forEach(r => {
      const label = r.closest('label');
      if(r.checked) {
        label.classList.remove('border-slate-200');
        label.classList.add('border-primary-500', 'bg-primary-50/30');
      } else {
        label.classList.add('border-slate-200');
        label.classList.remove('border-primary-500', 'bg-primary-50/30');
      }
    });
  }
  
  Array.prototype.forEach.call(radios, function(r){ r.addEventListener('change', setVisible); });
  setVisible();

  function applyLocal(){
    var ws = (document.getElementById('exec_workspace_root') || {}).value || '';
    var body = ws ? JSON.stringify({ workspace_root: ws }) : '{}';
    
    // Visual feedback
    var btn = document.getElementById('btnApplyMode');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Saving...';
    btn.disabled = true;

    fetch('/api/exec/local', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: body })
      .then(r=>r.json()).then(function(res){ 
        if(res && res.error){ alert('Failed: ' + res.error); return; } 
        
        // Auto run health check after apply
        testConn();
      })
      .catch(function(e){ alert('Failed: ' + e); })
      .finally(function(){
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  function applySSH(){
    var host = (document.getElementById('ssh_host')||{}).value||'';
    var user = (document.getElementById('ssh_user')||{}).value||'';
    var port = parseInt((document.getElementById('ssh_port')||{}).value||'22',10)||22;
    var key_path = (document.getElementById('ssh_key_path')||{}).value||'';
    var password = (document.getElementById('ssh_password')||{}).value||'';
    var shell = (document.getElementById('ssh_shell')||{}).value||'/bin/bash';
    var login_shell = !!((document.getElementById('ssh_login_shell')||{}).checked);
    var ws = (document.getElementById('exec_workspace_root')||{}).value||'';
    
    if(!host){ alert('Please enter SSH host'); return; }
    
    var payload = { host: host, port: port, shell: shell, login_shell: login_shell };
    if(user) payload.user = user;
    if(key_path) payload.key_path = key_path;
    if(password) payload.password = password;
    if(ws) payload.workspace_root = ws;

    var btn = document.getElementById('btnApplyMode');
    var originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Saving...';
    btn.disabled = true;

    fetch('/api/exec/ssh', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(function(res){ 
        if(res && res.error){ alert('Failed: ' + res.error); return; } 
        testConn();
      })
      .catch(function(e){ alert('Failed: ' + e); })
      .finally(function(){
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  function testConn(){
    var el = document.getElementById('testResult'); 
    if(el) { 
      el.style.display='inline-flex'; 
      el.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-1"></i> Testing...'; 
      el.className = 'hidden px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 inline-flex items-center'; 
    }
    
    if(window.__openHealthModal) {
      window.__openHealthModal().then(function(res){
        var data = (res && res.data) || {}; var ok = !!(res && res.ok);
        var el = document.getElementById('testResult'); if(!el) return;
        
        if(ok) {
          el.innerHTML = '<i class="fa-solid fa-check-circle mr-1"></i> Connected (' + (data.exec_mode||'?') + ')';
          el.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 inline-flex items-center';
        } else {
          el.innerHTML = '<i class="fa-solid fa-times-circle mr-1"></i> Failed';
          el.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 inline-flex items-center';
          el.title = data.error || 'Unknown error';
        }
      });
    }
  }

  var bMode = document.getElementById('btnApplyMode');
  if(bMode) {
    bMode.addEventListener('click', function(){
      var checked = Array.prototype.find.call(radios, function(r){ return r.checked; });
      var mode = checked ? checked.value : 'local';
      if(mode === 'ssh') { applySSH(); } else { applyLocal(); }
    });
  }
  
  var bTest = document.getElementById('btnTest'); 
  if(bTest) bTest.addEventListener('click', testConn);
  
  // Toggle show/hide SSH password
  var pwd = document.getElementById('ssh_password');
  var tog = document.getElementById('ssh_password_toggle');
  if(tog && pwd){
    tog.addEventListener('click', function(){
      var isPwd = pwd.getAttribute('type') === 'password';
      pwd.setAttribute('type', isPwd ? 'text' : 'password');
      var icon = tog.querySelector('i');
      if(icon) icon.className = isPwd ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
    });
  }
})();
</script>
{% endblock %}
