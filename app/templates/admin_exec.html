{% extends "layout.html" %}
{% block content %}
{% set cfg = (config or {}) %}
{% set exec = (cfg.get('exec', {}) if cfg else {}) %}
{% set ssh = (exec.get('ssh', {}) if exec else {}) %}
<div class="page-title">
  <h2>Execution Settings</h2>
  <span class="badge">Workspace: {{ exec.get('workspace_root', cfg.get('workspace_root','')) or '-' }}</span>
</div>

<div class="group">
  <div class="group-title">Mode</div>
  <div class="card">
    <p style="color: var(--muted); font-size:13px; margin-top:0;">Run locally on this server or via SSH on a remote Linux host.</p>

  <div class="row" style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
    <label><input type="radio" name="exec_mode" value="local" {% if exec.get('mode','local') != 'ssh' %}checked{% endif %}/> Local</label>
    <label><input type="radio" name="exec_mode" value="ssh" {% if exec.get('mode') == 'ssh' %}checked{% endif %}/> SSH</label>
    <span class="badge">Current: {% if exec.get('mode') == 'ssh' %}ssh {{ ssh.get('user','') }}@{{ ssh.get('host','') }}:{{ ssh.get('port',22) }}{% else %}local{% endif %}</span>
  </div>

    <div class="row">
      <label>Workspace Root</label>
      <input id="exec_workspace_root" type="text" placeholder="/path/to/workspace" value="{{ exec.get('workspace_root', cfg.get('workspace_root','')) }}"/>
      <div style="color: var(--muted); font-size:12px; margin-top:4px;">Directory where p4 client workspace lives.</div>
    </div>

    <div id="sshFields" class="row" style="display:none;">
      <div class="grid grid-2">
        <div class="stat-card">
          <div class="stat-label">SSH Host</div>
          <input id="ssh_host" type="text" placeholder="host or IP" value="{{ ssh.get('host','') }}"/>
          <div class="spark"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">User</div>
          <input id="ssh_user" type="text" placeholder="username" value="{{ ssh.get('user','') }}"/>
          <div class="spark"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Port</div>
          <input id="ssh_port" type="number" placeholder="22" value="{{ ssh.get('port',22) }}"/>
          <div class="spark"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Key Path (optional)</div>
          <input id="ssh_key_path" type="text" placeholder="~/.ssh/id_rsa" value="{{ ssh.get('key_path','') }}"/>
          <div class="spark"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Password (optional)</div>
          <div style="position:relative;">
            <input id="ssh_password" type="password" placeholder="password if not using key" value=""/>
            <button id="ssh_password_toggle" type="button" class="btn" aria-label="Show/Hide password" title="Show/Hide" style="position:absolute; right:6px; top:50%; transform: translateY(-50%); padding:4px 8px; font-size:12px;">üëÅ</button>
          </div>
          <div class="spark"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Shell</div>
          <input id="ssh_shell" type="text" placeholder="/bin/bash" value="{{ ssh.get('shell','/bin/bash') }}"/>
          <div class="spark"></div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <label><input id="ssh_login_shell" type="checkbox" {% if ssh.get('login_shell') %}checked{% endif %}/> Login shell (-l)</label>
        </div>
      </div>
    </div>

    <div class="row" style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn btn-primary" id="btnApplyMode" type="button">Apply</button>
      <button class="btn" id="btnTest" type="button">Test Connection</button>
      <span id="testResult" class="badge" style="display:none;"></span>
    </div>
  </div>
</div>

<script>
(function(){
  var radios = document.querySelectorAll('input[name="exec_mode"]');
  var sshFields = document.getElementById('sshFields');
  function setVisible(){
    var checked = Array.prototype.find.call(radios, function(r){ return r.checked; });
    var mode = checked ? checked.value : 'local';
    if (sshFields) sshFields.style.display = (mode === 'ssh') ? '' : 'none';
  }
  Array.prototype.forEach.call(radios, function(r){ r.addEventListener('change', setVisible); });
  setVisible();

  function applyLocal(){
    var ws = (document.getElementById('exec_workspace_root') || {}).value || '';
    var body = ws ? JSON.stringify({ workspace_root: ws }) : '{}';
    fetch('/api/exec/local', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: body })
      .then(r=>r.json()).then(function(res){ if(res && res.error){ alert('Failed: ' + res.error); return; } 
        // Auto run health check after apply
        var el = document.getElementById('testResult'); if(el){ el.style.display='inline-block'; el.textContent='Testing...'; el.className='badge'; }
        testConn();
      })
      .catch(function(e){ alert('Failed: ' + e); });
  }
  function applySSH(){
    var host = (document.getElementById('ssh_host')||{}).value||'';
    var user = (document.getElementById('ssh_user')||{}).value||'';
    var port = parseInt((document.getElementById('ssh_port')||{}).value||'22',10)||22;
    var key_path = (document.getElementById('ssh_key_path')||{}).value||'';
    var password = (document.getElementById('ssh_password')||{}).value||'';
    var shell = (document.getElementById('ssh_shell')||{}).value||'/bin/bash';
    var login_shell = !!((document.getElementById('ssh_login_shell')||{}).checked);
    var ws = (document.getElementById('exec_workspace_root')||{}).value||'';
    if(!host){ alert('Please enter SSH host'); return; }
    var payload = { host: host, port: port, shell: shell, login_shell: login_shell };
    if(user) payload.user = user;
    if(key_path) payload.key_path = key_path;
    if(password) payload.password = password;
    if(ws) payload.workspace_root = ws;
    fetch('/api/exec/ssh', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(function(res){ if(res && res.error){ alert('Failed: ' + res.error); return; } 
        // Auto run health check after apply
        var el = document.getElementById('testResult'); if(el){ el.style.display='inline-block'; el.textContent='Testing...'; el.className='badge'; }
        testConn();
      })
      .catch(function(e){ alert('Failed: ' + e); });
  }
  function testConn(){
    var el = document.getElementById('testResult'); if(el) { el.style.display='inline-block'; el.textContent = 'Testing...'; el.className = 'badge'; }
    if(window.__openHealthModal) {
      window.__openHealthModal().then(function(res){
        var data = (res && res.data) || {}; var ok = !!(res && res.ok);
        var el = document.getElementById('testResult'); if(!el) return;
        el.textContent = ok ? ('OK (' + (data.exec_mode||'?') + ')') : ('FAILED' + (data.error ? (': ' + data.error) : ''));
        el.className = 'badge ' + (ok ? 'ok' : 'err');
      });
    }
  }
  var bMode = document.getElementById('btnApplyMode');
  if(bMode) {
    bMode.addEventListener('click', function(){
      var checked = Array.prototype.find.call(radios, function(r){ return r.checked; });
      var mode = checked ? checked.value : 'local';
      if(mode === 'ssh') { applySSH(); } else { applyLocal(); }
    });
  }
  var bTest = document.getElementById('btnTest'); if(bTest) bTest.addEventListener('click', testConn);
  // Toggle show/hide SSH password
  var pwd = document.getElementById('ssh_password');
  var tog = document.getElementById('ssh_password_toggle');
  if(tog && pwd){
    tog.addEventListener('click', function(){
      var isPwd = pwd.getAttribute('type') === 'password';
      pwd.setAttribute('type', isPwd ? 'text' : 'password');
      tog.textContent = isPwd ? 'üôà' : 'üëÅ';
      tog.setAttribute('title', isPwd ? 'Hide' : 'Show');
      tog.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
    });
  }
})();
</script>
{% endblock %}
