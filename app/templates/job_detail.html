{% extends "layout.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  
  <!-- Left Column: Status & Actions -->
  <div class="lg:col-span-1 space-y-6">
    
    <!-- Job Info Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800">Job Details</h2>
        {% if job.readable_id %}
        <span class="px-2.5 py-1 rounded-md bg-blue-50 text-blue-700 text-xs font-semibold border border-blue-100">{{ job.readable_id }}</span>
        {% endif %}
      </div>
      
      <div class="mb-6">
         <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">UUID</div>
         <code class="block w-full p-2 bg-slate-50 border border-slate-100 rounded text-xs font-mono text-slate-600 cursor-pointer hover:bg-slate-100 transition-colors break-all" onclick="copyToClipboard('{{ job.id }}')" title="Click to copy">{{ job.id }}</code>
      </div>

      <!-- Status Indicator -->
      <div id="status-container" class="mb-6 p-4 rounded-xl border transition-all duration-300 flex items-center justify-between bg-slate-50 border-slate-200">
        <div class="flex items-center gap-3">
          <div id="status-indicator" class="w-3 h-3 rounded-full transition-all duration-300 shadow-sm"></div>
          <div class="flex flex-col">
            <span class="text-xs font-medium text-slate-500 uppercase tracking-wider">Status</span>
            <div class="flex items-center gap-2">
              <span id="status-badge" class="font-semibold text-slate-800">{{ job.status }}</span>
              <span id="stage-text" class="text-sm text-slate-500 {% if not job.stage %}hidden{% endif %}">({{ job.stage }})</span>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Updated</div>
          <div id="current-status-time" class="text-xs font-mono text-slate-600"></div>
        </div>
      </div>

      <!-- Key Info -->
      <div class="space-y-3 text-sm border-t border-slate-100 pt-4">
        <div class="flex justify-between">
          <span class="text-slate-500">Changelist</span>
          <span class="font-mono font-medium text-slate-700">{{ job.changelist or '-' }}</span>
        </div>
        {% if job.payload and job.payload.trial %}
        <div class="flex justify-between">
          <span class="text-slate-500">Mode</span>
          <span class="px-2 py-0.5 rounded text-[10px] font-medium bg-purple-50 text-purple-700 border border-purple-100">Trial Run</span>
        </div>
        {% endif %}
      </div>

      <!-- Dynamic PIDs -->
      <div class="mt-4 pt-4 border-t border-slate-100 space-y-3">
        {% if job.stage == 'integrate' and job.pids and job.pids.integrate %}
          <div class="flex justify-between items-center">
            <span class="text-xs font-medium text-slate-500">Integrate PID</span>
            <code class="text-xs bg-slate-100 px-1.5 py-0.5 rounded">{{ job.pids.integrate }}</code>
          </div>
        {% elif job.stage == 'submit' and job.pids and job.pids.p4push %}
          <div class="flex justify-between items-center">
            <span class="text-xs font-medium text-slate-500">Push PID</span>
            <code class="text-xs bg-slate-100 px-1.5 py-0.5 rounded">{{ job.pids.p4push }}</code>
          </div>
        {% endif %}
        
        <button class="w-full mt-2 py-1.5 text-xs font-medium text-slate-600 hover:text-primary-600 border border-slate-200 rounded hover:border-primary-300 hover:bg-primary-50 transition-colors flex items-center justify-center gap-2" type="button" id="btn-hb">
          <i class="fa-solid fa-heart-pulse"></i> Check Process Health
          <span id="hb-res" class="ml-2 font-normal text-slate-400"></span>
        </button>
      </div>

    </div>

    <!-- Actions Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <h3 class="text-sm font-semibold text-slate-800 uppercase tracking-wider mb-4">Actions</h3>
      <div class="space-y-3">
        
        {% if job.status == 'needs_resolve' %}
        <form method="post" action="/admin/jobs/{{ job.id }}/resolve">
          <input type="hidden" name="mode" value="merge" />
          <button class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all" type="submit">
            <i class="fa-solid fa-wrench mr-2"></i> Auto Resolve
          </button>
          <p class="text-xs text-center text-slate-500 mt-2">Run resolve -am and check conflicts.</p>
        </form>
        {% endif %}

        {% if job.status in ['ready_to_submit'] %}
        <form id="form-continue-submit">
          <button class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all" type="submit">
            <i class="fa-solid fa-check mr-2"></i> Submit Changelist
          </button>
          <p class="text-xs text-center text-slate-500 mt-2">Shelve and push via p4push.</p>
        </form>
        {% endif %}

        {% if job.status in ['awaiting_approval'] %}
        <div class="grid grid-cols-2 gap-3">
          <form method="post" action="/admin/jobs/{{ job.id }}/approve">
            <button class="w-full px-4 py-2 rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition-all" type="submit">Approve</button>
          </form>
          <form method="post" action="/admin/jobs/{{ job.id }}/reject">
            <button class="w-full px-4 py-2 rounded-lg shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition-all" type="submit">Reject</button>
          </form>
        </div>
        {% endif %}

        <div class="pt-2 flex gap-3">
           <button class="flex-1 px-4 py-2 border border-red-200 rounded-lg shadow-sm text-sm font-medium text-red-600 bg-white hover:bg-red-50 transition-all" type="button" id="btn-cancel">
             Cancel
           </button>
           <button class="flex-1 px-4 py-2 border border-slate-200 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 transition-all" type="button" id="btn-retry">
             Retry
           </button>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="mt-6 pt-6 border-t border-slate-100">
        <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">Quick Links</h4>
        <div class="flex flex-wrap gap-2">
          <a href="/api/jobs/{{ job.id }}" target="_blank" class="px-2.5 py-1.5 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded text-xs text-slate-600 transition-colors">JSON</a>
          <a href="/api/jobs/{{ job.id }}/heartbeat" target="_blank" class="px-2.5 py-1.5 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded text-xs text-slate-600 transition-colors">Heartbeat</a>
          <a href="/api/jobs/{{ job.id }}/process_status" target="_blank" class="px-2.5 py-1.5 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded text-xs text-slate-600 transition-colors">Proc Status</a>
        </div>
      </div>
      
      <!-- Artifacts -->
      <div class="mt-6 pt-6 border-t border-slate-100">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Artifacts</h4>
          <button id="btn-toggle-artifacts" class="text-xs text-primary-600 hover:text-primary-800">Show</button>
        </div>
        <div id="artifacts-panel" class="hidden bg-slate-50 rounded-lg border border-slate-200 p-3">
          <div id="artifacts-list" class="text-xs font-mono text-slate-600 space-y-1"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Right Column: Logs & Conflicts -->
  <div class="lg:col-span-2 space-y-6">
    
    <!-- Conflicts Section -->
    {% if job.conflicts %}
    <div class="bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden">
      <div class="bg-amber-50 px-6 py-4 border-b border-amber-100 flex justify-between items-center">
        <h3 class="text-sm font-bold text-amber-800 flex items-center gap-2">
          <i class="fa-solid fa-triangle-exclamation"></i> Conflicts ({{ job.conflicts|length }})
        </h3>
      </div>
      <div class="p-6">
        <div class="max-h-48 overflow-y-auto bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-mono text-slate-700 mb-4">
          {% for f in job.conflicts %}
            <div class="py-0.5">{{ f }}</div>
          {% endfor %}
        </div>
        
        <div class="flex flex-wrap gap-3">
          <button class="px-3 py-2 bg-white border border-slate-300 rounded-md text-xs font-medium text-slate-700 hover:bg-slate-50 transition-all shadow-sm" type="button" id="btn-generate-all">
            Generate Resolve All Command
          </button>
          <button class="px-3 py-2 bg-white border border-slate-300 rounded-md text-xs font-medium text-slate-700 hover:bg-slate-50 transition-all shadow-sm" type="button" id="btn-generate-individual">
            Generate Individual Commands
          </button>
        </div>

        <div id="resolve-commands" class="hidden mt-4">
          <div class="bg-slate-800 rounded-lg p-4 relative group">
            <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
               <button id="btn-copy-commands" class="px-2 py-1 bg-white/10 hover:bg-white/20 text-white rounded text-xs">Copy</button>
               <button id="btn-select-all" class="px-2 py-1 bg-white/10 hover:bg-white/20 text-white rounded text-xs">Select</button>
            </div>
            <pre id="commands-text" class="text-xs font-mono text-green-400 whitespace-pre-wrap break-all"></pre>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if job.blocked_files and job.status == 'blocked' %}
    <div class="bg-white rounded-xl shadow-sm border border-red-200 overflow-hidden">
       <div class="bg-red-50 px-6 py-4 border-b border-red-100">
        <h3 class="text-sm font-bold text-red-800 flex items-center gap-2">
          <i class="fa-solid fa-ban"></i> Blocked Files
        </h3>
      </div>
      <div class="p-6">
        <ul class="list-disc list-inside text-sm text-slate-700 font-mono">
        {% for f in job.blocked_files %}
          <li>{{ f }}</li>
        {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- Process Monitor -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100">
        <h3 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-microchip text-slate-400"></i> Process Monitor
        </h3>
      </div>
      <div class="p-6" id="process-monitor">
        <div class="animate-pulse flex space-x-4">
          <div class="flex-1 space-y-4 py-1">
            <div class="h-4 bg-slate-100 rounded w-3/4"></div>
            <div class="space-y-2">
              <div class="h-4 bg-slate-100 rounded"></div>
              <div class="h-4 bg-slate-100 rounded w-5/6"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-terminal text-slate-400"></i> Execution Log
        </h3>
        <span class="text-xs text-slate-400">Auto-refreshing</span>
      </div>
      <div class="bg-slate-900 p-4 overflow-x-auto">
        <pre class="font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed">{% for line in job.log %}{{ line }}{% endfor %}</pre>
      </div>
    </div>

  </div>
</div>

<script>
// Original JS Logic Preserved & Adapted
(function(){
  var jobId = "{{ job.id }}";
  var btnCancel = document.getElementById('btn-cancel');
  var btnRetry = document.getElementById('btn-retry');
  var btnToggleArtifacts = document.getElementById('btn-toggle-artifacts');
  var artifactsPanel = document.getElementById('artifacts-panel');
  var artifactsList = document.getElementById('artifacts-list');
  
  if(btnCancel){
    btnCancel.addEventListener('click', function(){
      if(!confirm('Are you sure you want to cancel this job?')) return;
      fetch('/api/jobs/' + jobId + '/cancel', {method:'POST'})
        .then(r => r.json())
        .then(function(res){ location.reload(); })
        .catch(function(_){ alert('Cancel failed'); });
    });
  }
  
  if(btnRetry){
    btnRetry.addEventListener('click', function(){
      if(!confirm('Retry will kill current job, clean workspace, and spawn new isolated process. Continue?')) return;
      btnRetry.disabled = true;
      btnRetry.textContent = 'Retrying...';
      fetch('/api/jobs/' + jobId + '/retry?mode=process', {method:'POST'})
        .then(function(r) {
          if(!r.ok) return r.json().then(e => { throw new Error(e.error || 'HTTP ' + r.status); });
          return r.json();
        })
        .then(function(res){ 
          if(res && res.ok){ 
            alert('Job queued for retry successfully');
            location.reload(); 
          } else { 
            alert(res.error || 'Retry failed'); 
            btnRetry.disabled = false;
            btnRetry.textContent = 'Retry';
          } 
        })
        .catch(function(err){ 
          alert('Retry failed: ' + err.message);
          btnRetry.disabled = false;
          btnRetry.textContent = 'Retry';
        });
    });
  }
  
  var formContinueSubmit = document.getElementById('form-continue-submit');
  if(formContinueSubmit){
    formContinueSubmit.addEventListener('submit', function(e){
      e.preventDefault();
      if(!confirm('Continue to submit? This will shelve the changelist and push via p4push.')) return;
      var btn = formContinueSubmit.querySelector('button[type="submit"]');
      if(btn){ btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Submitting...'; }
      fetch('/api/jobs/' + jobId + '/continue_to_submit', {method:'POST'})
        .then(function(r){ if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(function(res){ alert('Submit initiated successfully'); location.reload(); })
        .catch(function(err){ alert('Submit failed: ' + err.message); if(btn){ btn.disabled = false; btn.textContent = 'Submit Changelist'; } });
    });
  }

  if(btnToggleArtifacts && artifactsPanel && artifactsList){
    btnToggleArtifacts.addEventListener('click', function(){
      var isHidden = artifactsPanel.classList.contains('hidden');
      if(isHidden) artifactsPanel.classList.remove('hidden'); else artifactsPanel.classList.add('hidden');
      btnToggleArtifacts.textContent = isHidden ? 'Hide' : 'Show';
      
      if(isHidden && !artifactsList.getAttribute('data-loaded')){
        fetch('/api/jobs/' + jobId + '/artifacts').then(r=>r.json()).then(function(res){
          var items = (res && res.artifacts) ? res.artifacts : [];
          if(!items.length){ artifactsList.innerHTML = '<div class="text-slate-400 italic">No artifacts found</div>'; artifactsList.setAttribute('data-loaded','1'); return; }
          var html = '<ul class="space-y-1">' + items.map(function(name){
            var u = '/api/jobs/' + jobId + '/artifacts/' + encodeURIComponent(name);
            return '<li><a href="' + u + '" target="_blank" class="hover:text-primary-600 flex items-center gap-2"><i class="fa-solid fa-file-lines text-slate-400"></i> ' + name + '</a></li>';
          }).join('') + '</ul>';
          artifactsList.innerHTML = html;
          artifactsList.setAttribute('data-loaded','1');
        }).catch(function(_){ artifactsList.innerHTML = '<span class="text-red-500">Failed to load</span>'; artifactsList.setAttribute('data-loaded','1'); });
      }
    });
  }
  
  // Resolve Commands Logic
  var btnGenerateAll = document.getElementById('btn-generate-all');
  var btnGenerateIndividual = document.getElementById('btn-generate-individual');
  var btnCopy = document.getElementById('btn-copy-commands');
  var btnSelectAll = document.getElementById('btn-select-all');
  var commandsDiv = document.getElementById('resolve-commands');
  var commandsText = document.getElementById('commands-text');
  var generatedCommands = '';
  
  function generateCommands(useWildcard) {
    fetch('/api/jobs/' + jobId).then(r => r.json()).then(function(job){
      if(!job || !job.conflicts || !job.conflicts.length){ alert('No conflicts found'); return; }
      var wsRoot = '{{ job.workspace_root or "/local_vol1_nobackup/nanyang/orion" }}';
      var client = '{{ job.client or "nanyang2_srdc_srdcws990_mkwa_local_vol1_nobackup_nanyang_orion" }}';
      var commands = ['cd ' + wsRoot];
      if(useWildcard) commands.push('p4 -c ' + client + ' resolve ...');
      else job.conflicts.forEach(f => commands.push('p4 -c ' + client + ' resolve ' + f));
      generatedCommands = commands.join('\n');
      commandsText.textContent = generatedCommands;
      commandsDiv.classList.remove('hidden');
    }).catch(function(){ alert('Failed to get job details'); });
  }
  
  if(btnGenerateAll) btnGenerateAll.addEventListener('click', () => generateCommands(true));
  if(btnGenerateIndividual) btnGenerateIndividual.addEventListener('click', () => generateCommands(false));
  
  if(btnCopy) btnCopy.addEventListener('click', function(){
    if(!generatedCommands) return;
    if(window.copyToClipboard) window.copyToClipboard(generatedCommands);
    btnCopy.textContent = 'Copied!'; setTimeout(()=>btnCopy.textContent='Copy', 2000);
  });
  
  if(btnSelectAll) btnSelectAll.addEventListener('click', function(){
    if(!generatedCommands) return;
    var range = document.createRange(); range.selectNodeContents(commandsText);
    window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
    btnSelectAll.textContent = 'Selected!'; setTimeout(()=>btnSelectAll.textContent='Select', 2000);
  });

  // Status Indicator Logic
  var statusBadge = document.getElementById('status-badge');
  var stageText = document.getElementById('stage-text');
  var indicator = document.getElementById('status-indicator');
  var container = document.getElementById('status-container');
  
  function updateStatusUI(status, stage) {
    if(statusBadge) statusBadge.textContent = status;
    if(stageText) {
        if(stage){ stageText.classList.remove('hidden'); stageText.textContent = '(' + stage + ')'; }
        else { stageText.classList.add('hidden'); }
    }

    // Config
    const config = {
      'running': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'integrate': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'resolving': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'resolve': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'submitted': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: false },
      'done': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: false },
      
      'pending': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: true },
      'queued': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: false },
      
      'blocked': { color: 'bg-amber-500', bg: 'bg-amber-50', border: 'border-amber-200', animate: true },
      'needs_resolve': { color: 'bg-amber-500', bg: 'bg-amber-50', border: 'border-amber-200', animate: true },
      
      'error': { color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-200', animate: false },
      'failed': { color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-200', animate: false },
      'cancelled': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: false }
    };
    
    const c = config[status] || config['queued'];
    
    if(indicator) {
      indicator.className = `w-3 h-3 rounded-full shadow-sm transition-all duration-300 ${c.color} ${c.animate ? 'animate-pulse' : ''}`;
    }
    if(container) {
      container.className = `mb-6 p-4 rounded-xl border transition-all duration-300 flex items-center justify-between ${c.bg} ${c.border}`;
    }
  }

  // SSE for Status
  try{
    if(window.EventSource){
      var es = new EventSource('/api/stream?job_id=' + encodeURIComponent(jobId));
      es.onmessage = function(ev){
        try{
          var data = JSON.parse(ev.data);
          if(data) updateStatusUI(data.status, data.stage);
        }catch(e){}
      };
    }
  }catch(e){}

  // Process Monitor
  function loadProcessStatus(){
    fetch('/api/jobs/' + jobId + '/process_status').then(r => r.json()).then(function(data){
        var el = document.getElementById('process-monitor');
        if(!el) return;
        
        var activeProcesses = data.processes ? data.processes.filter(p => p.status !== 'not_found' && p.is_active) : [];
        if(activeProcesses.length === 0){ el.innerHTML = '<div class="text-center text-slate-400 py-4 text-sm">No active processes running</div>'; return; }
        
        var html = '<div class="space-y-3">';
        
        // P4 Connection
        var connIcon = data.p4_connection === 'ok' ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : '<i class="fa-solid fa-times-circle text-red-500"></i>';
        html += `<div class="text-xs font-medium text-slate-600 bg-slate-50 p-2 rounded flex items-center gap-2">${connIcon} P4 Connection</div>`;
        
        activeProcesses.forEach(function(proc){
          var color = proc.is_active ? 'green' : 'amber';
          var cpuColor = proc.cpu_percent > 50 ? 'text-red-600' : (proc.cpu_percent > 20 ? 'text-amber-600' : 'text-green-600');
          
          html += `<div class="bg-slate-50 rounded-lg border border-slate-200 p-3 text-xs">
            <div class="flex justify-between items-center mb-2">
              <div class="font-semibold text-slate-700 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-${color}-500 animate-pulse"></div>
                ${proc.stage}
              </div>
              <code class="bg-white px-1.5 py-0.5 rounded border border-slate-100 text-slate-500">PID ${proc.pid}</code>
            </div>
            <div class="grid grid-cols-3 gap-2 text-[10px] font-mono uppercase tracking-wider text-slate-500">
              <div>CPU: <span class="${cpuColor} font-bold">${proc.cpu_percent.toFixed(1)}%</span></div>
              <div>MEM: <span class="font-bold text-slate-700">${proc.memory_percent.toFixed(1)}%</span></div>
              <div>TIME: <span class="text-slate-700">${proc.runtime}</span></div>
            </div>
            ${proc.wchan ? `<div class="mt-2 text-[10px] text-slate-400 truncate" title="${proc.wchan}">Wait: ${proc.wchan}</div>` : ''}
          </div>`;
        });
        html += '</div>';
        el.innerHTML = html;
    }).catch(e => console.error(e));
  }
  
  loadProcessStatus();
  setInterval(loadProcessStatus, 5000);
  updateStatusUI("{{ job.status }}", "{{ job.stage or '' }}");

  // Log Auto Reload
  setTimeout(function(){ location.reload(); }, 30000);
})();
</script>
{% endblock %}
