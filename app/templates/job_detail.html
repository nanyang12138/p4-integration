{% extends "layout.html" %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  
  <!-- Left Column: Status & Actions -->
  <div class="lg:col-span-1 space-y-6">
    
    <!-- Job Info Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-slate-800">Job Details</h2>
        {% if job.readable_id %}
        <span class="px-2.5 py-1 rounded-md bg-blue-50 text-blue-700 text-xs font-semibold border border-blue-100">{{ job.readable_id }}</span>
        {% endif %}
      </div>
      
      <div class="mb-6">
         <div class="text-xs font-medium text-slate-500 uppercase tracking-wider mb-1">UUID</div>
         <code class="block w-full p-2 bg-white border border-slate-300 rounded text-sm font-mono text-slate-900 cursor-pointer hover:bg-slate-50 transition-colors break-all select-all" onclick="copyToClipboard('{{ job.job_id or job.id }}')" title="Click to copy">
           {% if job.job_id %}{{ job.job_id }}{% elif job.id %}{{ job.id }}{% else %}[No ID Found - Keys: {{ job.keys()|list }}]{% endif %}
         </code>
      </div>

      <!-- Status Indicator -->
      <div id="status-container" class="mb-6 p-4 rounded-xl border transition-all duration-300 flex items-center justify-between bg-slate-50 border-slate-200">
        <div class="flex items-center gap-3">
          <div id="status-indicator" class="w-3 h-3 rounded-full transition-all duration-300 shadow-sm"></div>
          <div class="flex flex-col">
            <span class="text-xs font-medium text-slate-500 uppercase tracking-wider">Status</span>
            <div class="flex items-center gap-2">
              <span id="status-badge" class="font-semibold text-slate-800">{{ job.status }}</span>
              <span id="stage-text" class="text-sm text-slate-500 {% if not job.stage %}hidden{% endif %}">({{ job.stage }})</span>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-[10px] font-medium text-slate-400 uppercase tracking-wider">Updated</div>
          <div id="current-status-time" class="text-xs font-mono text-slate-600"></div>
        </div>
      </div>

      <!-- Key Info -->
      <div class="space-y-3 text-sm border-t border-slate-100 pt-4">
        <div class="flex justify-between">
          <span class="text-slate-500">Source CL</span>
          <span class="font-mono font-medium text-slate-700" id="source-cl-value">
            {% if job.source_changelist and job.source_changelist != 'latest' %}
              {{ job.source_changelist }}
            {% elif job.spec and job.spec.changelist %}
              {{ job.spec.changelist }}
            {% else %}
              <span class="text-amber-500 italic animate-pulse">fetching...</span>
            {% endif %}
          </span>
        </div>
        <div class="flex justify-between">
          <span class="text-slate-500">Shelved CL</span>
          <span class="font-mono font-medium text-slate-700">{{ job.changelist or '-' }}</span>
        </div>
        {% if job.payload and job.payload.trial %}
        <div class="flex justify-between">
          <span class="text-slate-500">Mode</span>
          <span class="px-2 py-0.5 rounded text-[10px] font-medium bg-purple-50 text-purple-700 border border-purple-100">Trial Run</span>
        </div>
        {% endif %}
      </div>

      <!-- Dynamic PIDs -->
      <div class="mt-4 pt-4 border-t border-slate-100 space-y-3">
        {% if job.stage == 'integrate' and job.pids and job.pids.integrate %}
          <div class="flex justify-between items-center">
            <span class="text-xs font-medium text-slate-500">Integrate PID</span>
            <code class="text-xs bg-slate-100 px-1.5 py-0.5 rounded">{{ job.pids.integrate }}</code>
          </div>
        {% elif job.stage == 'submit' and job.pids and job.pids.p4push %}
          <div class="flex justify-between items-center">
            <span class="text-xs font-medium text-slate-500">Push PID</span>
            <code class="text-xs bg-slate-100 px-1.5 py-0.5 rounded">{{ job.pids.p4push }}</code>
          </div>
        {% endif %}
        
        <button class="w-full mt-2 py-1.5 text-xs font-medium text-slate-600 hover:text-primary-600 border border-slate-200 rounded hover:border-primary-300 hover:bg-primary-50 transition-colors flex items-center justify-center gap-2" type="button" id="btn-hb">
          <i class="fa-solid fa-heart-pulse"></i> Check Process Health
          <span id="hb-res" class="ml-2 font-normal text-slate-400"></span>
        </button>
      </div>

      <!-- Connection Info (Collapsible) -->
      <details class="mt-4 pt-4 border-t border-slate-100">
        <summary class="cursor-pointer text-xs font-medium text-slate-500 hover:text-slate-700 flex items-center gap-2 select-none">
          <i class="fa-solid fa-chevron-right text-[10px] transition-transform details-chevron"></i>
          <i class="fa-solid fa-plug text-slate-400"></i>
          Connection Info
        </summary>
        <div class="mt-3 space-y-2 text-xs">
          <!-- SSH Info -->
          {% if job.spec and job.spec.connection %}
          <div class="bg-slate-50 rounded-lg p-3 space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-slate-500 flex-shrink-0">SSH Host</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 truncate max-w-[140px] cursor-pointer hover:bg-slate-50" title="{{ job.spec.connection.ssh_host }}:{{ job.spec.connection.ssh_port }}" onclick="copyToClipboard('{{ job.spec.connection.ssh_host }}:{{ job.spec.connection.ssh_port }}')">{{ job.spec.connection.ssh_host }}:{{ job.spec.connection.ssh_port }}</code>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-slate-500 flex-shrink-0">Master</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 truncate max-w-[140px] cursor-pointer hover:bg-slate-50" title="{{ job.spec.connection.master_host }}:{{ job.spec.connection.master_port }}" onclick="copyToClipboard('{{ job.spec.connection.master_host }}:{{ job.spec.connection.master_port }}')">{{ job.spec.connection.master_host }}:{{ job.spec.connection.master_port }}</code>
            </div>
            <!-- Python Path - full width -->
            <div class="pt-1 border-t border-slate-200">
              <span class="text-slate-500 block mb-1">Python</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 block truncate cursor-pointer hover:bg-slate-50" title="{{ job.spec.connection.python_path or 'python3' }}" onclick="copyToClipboard('{{ job.spec.connection.python_path or 'python3' }}')">{{ job.spec.connection.python_path or 'python3' }}</code>
            </div>
          </div>
          {% endif %}
          
          <!-- Workspace - full width layout -->
          {% if job.spec and job.spec.workspace %}
          <div class="bg-slate-50 rounded-lg p-3">
            <span class="text-slate-500 block mb-1">Workspace</span>
            <code class="bg-white px-1.5 py-0.5 rounded border border-slate-200 text-slate-700 block truncate cursor-pointer hover:bg-slate-50" title="{{ job.spec.workspace }}" onclick="copyToClipboard('{{ job.spec.workspace }}')">{{ job.spec.workspace }}</code>
          </div>
          {% endif %}
          
          <!-- P4 Info -->
          {% if job.spec and job.spec.p4 %}
          <div class="bg-blue-50 rounded-lg p-3 space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-blue-600 flex-shrink-0">P4 Port</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-blue-200 text-blue-700 truncate max-w-[140px] cursor-pointer hover:bg-blue-50" title="{{ job.spec.p4.port }}" onclick="copyToClipboard('{{ job.spec.p4.port }}')">{{ job.spec.p4.port }}</code>
            </div>
            <!-- P4 Client - full width -->
            <div class="pt-1 border-t border-blue-200">
              <span class="text-blue-600 block mb-1">P4 Client</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-blue-200 text-blue-700 block truncate cursor-pointer hover:bg-blue-50" title="{{ job.spec.p4.client }}" onclick="copyToClipboard('{{ job.spec.p4.client }}')">{{ job.spec.p4.client }}</code>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-blue-600 flex-shrink-0">P4 User</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-blue-200 text-blue-700">{{ job.spec.p4.user }}</code>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-blue-600 flex-shrink-0">P4 Password</span>
              <code class="bg-white px-1.5 py-0.5 rounded border border-blue-200 text-blue-700">
                {% if job.spec.p4.password %}****{{ job.spec.p4.password[-3:] if job.spec.p4.password|length > 3 else '***' }}{% else %}-{% endif %}
              </code>
            </div>
          </div>
          {% endif %}
          
          <!-- Agent ID - full width -->
          {% if job.agent_id %}
          <div class="bg-green-50 rounded-lg p-3">
            <span class="text-green-600 block mb-1">Agent ID</span>
            <code class="bg-white px-1.5 py-0.5 rounded border border-green-200 text-green-700 block truncate cursor-pointer hover:bg-green-50 text-[10px]" title="{{ job.agent_id }}" onclick="copyToClipboard('{{ job.agent_id }}')">{{ job.agent_id }}</code>
          </div>
          {% endif %}
        </div>
      </details>

    </div>

    <!-- Actions Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <h3 class="text-sm font-semibold text-slate-800 uppercase tracking-wider mb-4">Actions</h3>
      <div class="space-y-3">
        
        {% if job.status == 'needs_resolve' %}
        <form method="post" action="/api/jobs/{{ job.job_id }}/continue">
          <button class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-amber-500 hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-all" type="submit">
            <i class="fa-solid fa-sync mr-2"></i> Check & Continue
          </button>
          <p class="text-xs text-center text-slate-500 mt-2">Check if conflicts are resolved and continue.</p>
        </form>
        {% endif %}

        {% if job.status in ['ready_to_submit'] %}
        <form id="form-continue-submit">
          <button class="w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all" type="submit">
            <i class="fa-solid fa-check mr-2"></i> Submit Changelist
          </button>
          <p class="text-xs text-center text-slate-500 mt-2">Shelve and push via p4push.</p>
        </form>
        {% endif %}

        <div class="pt-2 flex gap-3">
           <button class="flex-1 px-4 py-2 border border-red-200 rounded-lg shadow-sm text-sm font-medium text-red-600 bg-white hover:bg-red-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" type="button" id="btn-cancel">
             Cancel
           </button>
           <button class="flex-1 px-4 py-2 border border-slate-200 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" type="button" id="btn-retry">
             Retry
           </button>
        </div>
        
        <!-- Retry status message -->
        <div id="retryStatusMsg" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center gap-2 text-blue-700 text-sm">
            <i class="fa-solid fa-circle-notch animate-spin"></i>
            <span id="retryStatusText">Connecting to remote machine...</span>
          </div>
          <p class="text-xs text-blue-600 mt-1">This may take up to 15 seconds.</p>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Right Column: Logs & Conflicts -->
  <div class="lg:col-span-2 space-y-6">
    
    <!-- Conflicts Section -->
    {% if job.conflicts %}
    <div class="bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden">
      <div class="bg-amber-50 px-6 py-4 border-b border-amber-100 flex justify-between items-center">
        <h3 class="text-sm font-bold text-amber-800 flex items-center gap-2">
          <i class="fa-solid fa-triangle-exclamation"></i> Conflicts ({{ job.conflicts|length }})
        </h3>
      </div>
      <div class="p-6">
        <div class="max-h-48 overflow-y-auto bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm font-mono text-slate-700 mb-4">
          {% for f in job.conflicts %}
            <div class="py-0.5">{{ f }}</div>
          {% endfor %}
        </div>
        
        <div class="flex flex-wrap gap-3">
          <button class="px-3 py-2 bg-white border border-slate-300 rounded-md text-xs font-medium text-slate-700 hover:bg-slate-50 transition-all shadow-sm" type="button" id="btn-generate-all">
            Generate Resolve All Command
          </button>
          <button class="px-3 py-2 bg-white border border-slate-300 rounded-md text-xs font-medium text-slate-700 hover:bg-slate-50 transition-all shadow-sm" type="button" id="btn-generate-individual">
            Generate Individual Commands
          </button>
        </div>

        <div id="resolve-commands" class="hidden mt-4">
          <div class="bg-slate-800 rounded-lg p-4 relative group">
            <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
               <button id="btn-copy-commands" class="px-2 py-1 bg-white/10 hover:bg-white/20 text-white rounded text-xs">Copy</button>
               <button id="btn-select-all" class="px-2 py-1 bg-white/10 hover:bg-white/20 text-white rounded text-xs">Select</button>
            </div>
            <pre id="commands-text" class="text-xs font-mono text-green-400 whitespace-pre-wrap break-all"></pre>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    {% if job.blocked_files and job.status == 'blocked' %}
    <div class="bg-white rounded-xl shadow-sm border border-red-200 overflow-hidden">
       <div class="bg-red-50 px-6 py-4 border-b border-red-100">
        <h3 class="text-sm font-bold text-red-800 flex items-center gap-2">
          <i class="fa-solid fa-ban"></i> Blocked Files
        </h3>
      </div>
      <div class="p-6">
        <ul class="list-disc list-inside text-sm text-slate-700 font-mono">
        {% for f in job.blocked_files %}
          <li>{{ f }}</li>
        {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    <!-- Process Monitor -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100">
        <h3 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-microchip text-slate-400"></i> Process Monitor
        </h3>
      </div>
      <div class="p-6" id="process-monitor">
        <div class="animate-pulse flex space-x-4">
          <div class="flex-1 space-y-4 py-1">
            <div class="h-4 bg-slate-100 rounded w-3/4"></div>
            <div class="space-y-2">
              <div class="h-4 bg-slate-100 rounded"></div>
              <div class="h-4 bg-slate-100 rounded w-5/6"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
        <h3 class="text-sm font-semibold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-terminal text-slate-400"></i> Execution Log
        </h3>
        <div class="flex items-center gap-3">
          <a href="/jobs/{{ job.job_id }}/logs/download" class="text-xs text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
            <i class="fa-solid fa-download"></i> Download Full Log
          </a>
          <span class="text-xs text-slate-400">Auto-refreshing</span>
        </div>
      </div>
      <div class="bg-slate-900 p-4 overflow-x-auto h-96 overflow-y-auto" id="log-container">
        <pre class="font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed" id="log-output">{% for line in job.log %}{{ line }}
{% endfor %}</pre>
      </div>
    </div>

  </div>
</div>

<script>
// Original JS Logic Preserved & Adapted
(function(){
  var jobId = "{{ job.job_id }}";
  var btnCancel = document.getElementById('btn-cancel');
  var btnRetry = document.getElementById('btn-retry');
  var btnCheckHealth = document.getElementById('btn-hb');
  var healthResult = document.getElementById('hb-res');
  
  if(btnCancel){
    btnCancel.addEventListener('click', function(){
      if(!confirm('Are you sure you want to cancel this job?')) return;
      fetch('/api/jobs/' + jobId + '/cancel', {method:'POST'})
        .then(r => r.json())
        .then(function(res){ location.reload(); })
        .catch(function(_){ alert('Cancel failed'); });
    });
  }
  
  if(btnRetry){
    var retryStatusMsg = document.getElementById('retryStatusMsg');
    var retryStatusText = document.getElementById('retryStatusText');
    var retryTimers = [];
    
    btnRetry.addEventListener('click', function(){
      if(!confirm('Retry will create a new job with the same configuration. Continue?')) return;
      
      // Show loading state
      btnRetry.disabled = true;
      btnRetry.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-1"></i> Retrying...';
      btnCancel.disabled = true;
      
      // Show status message
      if(retryStatusMsg) retryStatusMsg.classList.remove('hidden');
      if(retryStatusText) retryStatusText.textContent = 'Connecting to remote machine...';
      
      // Update status over time
      retryTimers = [
        setTimeout(function(){ if(retryStatusText) retryStatusText.textContent = 'Deploying agent...'; }, 3000),
        setTimeout(function(){ if(retryStatusText) retryStatusText.textContent = 'Waiting for agent to connect...'; }, 6000),
        setTimeout(function(){ if(retryStatusText) retryStatusText.textContent = 'Almost there...'; }, 10000)
      ];
      
      fetch('/api/jobs/' + jobId + '/retry', {method:'POST'})
        .then(function(r) {
          if(!r.ok) return r.json().then(e => { throw new Error(e.error || 'HTTP ' + r.status); });
          return r.json();
        })
        .then(function(res){ 
          retryTimers.forEach(function(t){ clearTimeout(t); });
          if(res && res.status === 'success' && res.new_job_id){ 
            if(retryStatusText) retryStatusText.textContent = 'Success! Redirecting...';
            window.location.href = '/jobs/' + res.new_job_id;
          } else { 
            alert(res.error || 'Retry failed'); 
            btnRetry.disabled = false;
            btnRetry.textContent = 'Retry';
            btnCancel.disabled = false;
            if(retryStatusMsg) retryStatusMsg.classList.add('hidden');
          } 
        })
        .catch(function(err){ 
          retryTimers.forEach(function(t){ clearTimeout(t); });
          alert('Retry failed: ' + err.message);
          btnRetry.disabled = false;
          btnRetry.textContent = 'Retry';
          btnCancel.disabled = false;
          if(retryStatusMsg) retryStatusMsg.classList.add('hidden');
        });
    });
  }
  
  if(btnCheckHealth){
    btnCheckHealth.addEventListener('click', function(){
      if(healthResult) healthResult.textContent = 'Checking...';
      fetch('/api/jobs/' + jobId + '/heartbeat')
        .then(r => r.json())
        .then(function(data){
          if(healthResult){
            if(data.connected){
              healthResult.textContent = '✓ Connected';
              healthResult.className = 'ml-2 font-normal text-green-600';
            } else {
              healthResult.textContent = '✗ Disconnected';
              healthResult.className = 'ml-2 font-normal text-red-600';
            }
          }
        })
        .catch(function(){
          if(healthResult){
            healthResult.textContent = 'Error';
            healthResult.className = 'ml-2 font-normal text-red-600';
          }
        });
    });
  }
  
  var formContinueSubmit = document.getElementById('form-continue-submit');
  if(formContinueSubmit){
    formContinueSubmit.addEventListener('submit', function(e){
      e.preventDefault();
      if(!confirm('Continue to submit? This will shelve the changelist and push via p4push.')) return;
      var btn = formContinueSubmit.querySelector('button[type="submit"]');
      if(btn){ btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch animate-spin mr-2"></i> Submitting...'; }
      fetch('/api/jobs/' + jobId + '/continue_to_submit', {method:'POST'})
        .then(function(r){ if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(function(res){ alert('Submit initiated successfully'); location.reload(); })
        .catch(function(err){ alert('Submit failed: ' + err.message); if(btn){ btn.disabled = false; btn.textContent = 'Submit Changelist'; } });
    });
  }

  // Resolve Commands Logic
  var btnGenerateAll = document.getElementById('btn-generate-all');
  var btnGenerateIndividual = document.getElementById('btn-generate-individual');
  var btnCopy = document.getElementById('btn-copy-commands');
  var btnSelectAll = document.getElementById('btn-select-all');
  var commandsDiv = document.getElementById('resolve-commands');
  var commandsText = document.getElementById('commands-text');
  var generatedCommands = '';
  
  function generateCommands(useWildcard) {
    fetch('/api/jobs/' + jobId).then(r => r.json()).then(function(job){
      if(!job || !job.conflicts || !job.conflicts.length){ alert('No conflicts found'); return; }
      var wsRoot = '{{ job.workspace_root or "/local_vol1_nobackup/nanyang/orion" }}';
      var client = '{{ job.client or "nanyang2_srdc_srdcws990_mkwa_local_vol1_nobackup_nanyang_orion" }}';
      var commands = ['cd ' + wsRoot];
      if(useWildcard) commands.push('p4 -c ' + client + ' resolve ...');
      else job.conflicts.forEach(f => commands.push('p4 -c ' + client + ' resolve ' + f));
      generatedCommands = commands.join('\n');
      commandsText.textContent = generatedCommands;
      commandsDiv.classList.remove('hidden');
    }).catch(function(){ alert('Failed to get job details'); });
  }
  
  if(btnGenerateAll) btnGenerateAll.addEventListener('click', () => generateCommands(true));
  if(btnGenerateIndividual) btnGenerateIndividual.addEventListener('click', () => generateCommands(false));
  
  if(btnCopy) btnCopy.addEventListener('click', function(){
    if(!generatedCommands) return;
    if(window.copyToClipboard) window.copyToClipboard(generatedCommands);
    btnCopy.textContent = 'Copied!'; setTimeout(()=>btnCopy.textContent='Copy', 2000);
  });
  
  if(btnSelectAll) btnSelectAll.addEventListener('click', function(){
    if(!generatedCommands) return;
    var range = document.createRange(); range.selectNodeContents(commandsText);
    window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
    btnSelectAll.textContent = 'Selected!'; setTimeout(()=>btnSelectAll.textContent='Select', 2000);
  });

  // ========== Timer Management ==========
  var timers = {
    pageReload: null,
    logFetch: null,
    sourceCL: null,
    processStatus: null
  };
  
  // Check if job is in terminal state (no more updates expected)
  function isTerminalState(status) {
    var terminalStates = ['done', 'error', 'cancelled', 'failed'];
    return terminalStates.indexOf((status || '').toLowerCase()) !== -1;
  }
  
  // Stop all timers when job reaches terminal state
  function stopAllTimers() {
    if (timers.pageReload) { clearTimeout(timers.pageReload); timers.pageReload = null; }
    if (timers.logFetch) { clearInterval(timers.logFetch); timers.logFetch = null; }
    if (timers.sourceCL) { clearInterval(timers.sourceCL); timers.sourceCL = null; }
    if (timers.processStatus) { clearInterval(timers.processStatus); timers.processStatus = null; }
    console.log('[JobDetail] All timers stopped - job in terminal state');
  }
  
  // Current job status (will be updated by SSE or API)
  var currentStatus = "{{ job.status }}";

  // ========== Log Fetching ==========
  var logOutput = document.getElementById('log-output');
  var logContainer = document.getElementById('log-container');
  var lastLogLength = 0;

  async function fetchLogs() {
    try {
      const response = await fetch('/api/jobs/' + jobId + '/logs');
      if (!response.ok) {
        console.error('Failed to fetch logs:', response.status);
        return;
      }
      const logs = await response.json();
      
      // Build log text
      let logText = '';
      for (let entry of logs) {
        const line = entry.data || '';
        
        // Check if it's a real error or just stderr output
        const isRealError = line.toLowerCase().includes('error:') || 
                           line.toLowerCase().includes('fatal:') || 
                           line.toLowerCase().includes('failed:') ||
                           line.toLowerCase().includes('not found') ||
                           line.toLowerCase().includes('permission denied') ||
                           line.toLowerCase().includes('traceback');
        
        if (entry.stream === 'stdout') {
          logText += line + '\n';
        } else if (entry.stream === 'stderr') {
          // Many tools output info to stderr, not all stderr is error
          // Only add [ERROR] prefix for real errors
          if (isRealError) {
            logText += '[ERROR] ' + line + '\n';
          } else {
            // For informational stderr (like bootenv output), show normally
            logText += line + '\n';
          }
        }
      }
      
      // Update if changed
      if (logs.length > lastLogLength) {
        logOutput.textContent = logText;
        // Auto-scroll to bottom
        logContainer.scrollTop = logContainer.scrollHeight;
        lastLogLength = logs.length;
      }
    } catch (error) {
      console.error('Error fetching logs:', error);
    }
  }

  // ========== Source CL Update ==========
  var sourceClValue = document.getElementById('source-cl-value');
  async function updateSourceCL() {
    try {
      const response = await fetch('/api/jobs/' + jobId);
      const job = await response.json();
      if (job.source_changelist && job.source_changelist !== 'latest' && sourceClValue) {
        // Update to show actual CL number
        sourceClValue.innerHTML = job.source_changelist;
        sourceClValue.className = 'font-mono font-medium text-slate-700';
      }
      
      // Check if status changed to terminal state
      if (job.status && isTerminalState(job.status) && !isTerminalState(currentStatus)) {
        currentStatus = job.status;
        stopAllTimers();
      }
    } catch (error) {
      console.error('Error updating source CL:', error);
    }
  }

  // Status Indicator Logic
  var statusBadge = document.getElementById('status-badge');
  var stageText = document.getElementById('stage-text');
  var indicator = document.getElementById('status-indicator');
  var container = document.getElementById('status-container');
  
  function updateStatusUI(status, stage) {
    if(statusBadge) statusBadge.textContent = status;
    if(stageText) {
        if(stage){ stageText.classList.remove('hidden'); stageText.textContent = '(' + stage + ')'; }
        else { stageText.classList.add('hidden'); }
    }

    // Config
    const config = {
      'running': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'integrate': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'resolving': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'resolve': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: true },
      'submitted': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: false },
      'done': { color: 'bg-green-500', bg: 'bg-green-50', border: 'border-green-200', animate: false },
      
      'pending': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: true },
      'queued': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: false },
      
      'blocked': { color: 'bg-amber-500', bg: 'bg-amber-50', border: 'border-amber-200', animate: true },
      'needs_resolve': { color: 'bg-amber-500', bg: 'bg-amber-50', border: 'border-amber-200', animate: true },
      
      'error': { color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-200', animate: false },
      'failed': { color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-200', animate: false },
      'cancelled': { color: 'bg-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', animate: false }
    };
    
    // Normalize status to lowercase for matching
    const normalizedStatus = (status || '').toLowerCase();
    const c = config[normalizedStatus] || config['queued'];
    
    if(indicator) {
      indicator.className = `w-3 h-3 rounded-full shadow-sm transition-all duration-300 ${c.color} ${c.animate ? 'animate-pulse' : ''}`;
    }
    if(container) {
      container.className = `mb-6 p-4 rounded-xl border transition-all duration-300 flex items-center justify-between ${c.bg} ${c.border}`;
    }
  }

  // SSE for Status
  try{
    if(window.EventSource){
      var es = new EventSource('/api/stream?job_id=' + encodeURIComponent(jobId));
      es.onmessage = function(ev){
        try{
          var data = JSON.parse(ev.data);
          if(data) {
            updateStatusUI(data.status, data.stage);
            
            // Check if status changed to terminal state
            if (data.status && isTerminalState(data.status) && !isTerminalState(currentStatus)) {
              currentStatus = data.status;
              stopAllTimers();
            }
          }
        }catch(e){}
      };
    }
  }catch(e){}

  // Process Monitor
  function loadProcessStatus(){
    fetch('/api/jobs/' + jobId + '/process_status').then(r => r.json()).then(function(data){
        var el = document.getElementById('process-monitor');
        if(!el) return;
        
        var html = '<div class="space-y-3">';
        
        // Agent Connection Status
        if(data.agent_connected){
          html += '<div class="text-xs font-medium text-slate-600 bg-green-50 p-2 rounded flex items-center gap-2">';
          html += '<i class="fa-solid fa-check-circle text-green-500"></i> Agent Connected';
          if(data.agent_id) html += ' <span class="text-slate-400">(' + data.agent_id + ')</span>';
          html += '</div>';
        } else {
          html += '<div class="text-xs font-medium text-slate-600 bg-red-50 p-2 rounded flex items-center gap-2">';
          html += '<i class="fa-solid fa-times-circle text-red-500"></i> Agent Disconnected';
          html += '</div>';
          // Show debug info
          if(data.debug){
            html += '<div class="text-[10px] text-slate-500 bg-slate-50 p-2 rounded mt-2">';
            html += '<div><strong>Debug:</strong> ' + data.debug.reason + '</div>';
            if(data.debug.job_agent_id) html += '<div>Job Agent ID: ' + data.debug.job_agent_id + '</div>';
            if(data.debug.connected_agents && data.debug.connected_agents.length > 0){
              html += '<div>Connected: ' + data.debug.connected_agents.join(', ') + '</div>';
            } else {
              html += '<div>No agents connected</div>';
            }
            html += '</div>';
          }
        }
        
        // Current Stage
        if(data.current_stage){
          html += '<div class="text-xs text-slate-600 bg-slate-50 p-2 rounded">';
          html += '<span class="font-medium">Current Stage:</span> ' + data.current_stage;
          html += '</div>';
        }
        
        // Process PIDs
        var pids = data.processes || {};
        var pidCount = Object.keys(pids).length;
        
        if(pidCount > 0){
          html += '<div class="space-y-2">';
          for(var name in pids){
            var pid = pids[name];
            html += '<div class="bg-slate-50 rounded-lg border border-slate-200 p-3 text-xs">';
            html += '<div class="flex justify-between items-center">';
            html += '<div class="font-semibold text-slate-700 flex items-center gap-2">';
            html += '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>';
            html += name.toUpperCase();
            html += '</div>';
            html += '<code class="bg-white px-1.5 py-0.5 rounded border border-slate-100 text-slate-500">PID ' + pid + '</code>';
            html += '</div>';
            html += '</div>';
          }
          html += '</div>';
        } else if(data.agent_connected){
          html += '<div class="text-center text-slate-400 py-4 text-sm">No active processes</div>';
        }
        
        html += '</div>';
        el.innerHTML = html;
    }).catch(e => console.error(e));
  }
  
  // ========== Initialize Timers (only if not in terminal state) ==========
  updateStatusUI("{{ job.status }}", "{{ job.stage or '' }}");
  
  // Initial data fetch
  fetchLogs();
  updateSourceCL();
  loadProcessStatus();
  
  // Start timers only if job is not in terminal state
  if (!isTerminalState(currentStatus)) {
    timers.logFetch = setInterval(fetchLogs, 2000);
    timers.sourceCL = setInterval(updateSourceCL, 2000);
    timers.processStatus = setInterval(loadProcessStatus, 5000);
    timers.pageReload = setTimeout(function(){ location.reload(); }, 30000);
    console.log('[JobDetail] Timers started - job is running');
  } else {
    console.log('[JobDetail] Timers not started - job already in terminal state');
  }
})();
</script>
{% endblock %}
