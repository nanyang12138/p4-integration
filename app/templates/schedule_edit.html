{% extends "layout.html" %}
{% block content %}
<div class="max-w-2xl mx-auto">
  
  <div class="mb-6">
    <a href="/schedules" class="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1 mb-2">
      <i class="fa-solid fa-arrow-left"></i> Back to Schedules
    </a>
    <h2 class="text-2xl font-bold text-slate-800 tracking-tight">
      {{ 'Edit Schedule' if schedule else 'New Schedule' }}
    </h2>
    <p class="text-sm text-slate-500 mt-1">Configure automated job execution.</p>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <form id="scheduleForm" class="p-6 space-y-6">
      
      <!-- Basic Info -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Schedule Name <span class="text-red-500">*</span></label>
        <input type="text" name="name" id="name" value="{{ schedule.name if schedule else '' }}" 
               class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500"
               placeholder="e.g. Daily Main Integration" required>
      </div>

      <!-- Template Selection -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Template <span class="text-red-500">*</span></label>
        <select name="template_id" id="template_id" 
                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" required>
          <option value="">Select a template...</option>
          {% for tpl in templates %}
          <option value="{{ tpl.id }}" {{ 'selected' if schedule and schedule.template_id == tpl.id else '' }}>
            {{ tpl.name }} ({{ tpl.type }})
          </option>
          {% endfor %}
        </select>
        <p class="mt-1 text-xs text-slate-500">
          <a href="/templates/new" class="text-primary-600 hover:text-primary-700">Create a new template</a> if needed.
        </p>
      </div>

      <!-- Cron Expression -->
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Cron Expression <span class="text-red-500">*</span></label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-clock text-slate-400 text-sm"></i>
          </div>
          <input type="text" name="cron" id="cron" value="{{ schedule.cron if schedule else '0 2 * * *' }}" 
                 class="w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 font-mono"
                 placeholder="0 2 * * *" required>
        </div>
        <p id="cronPreview" class="mt-1 text-xs text-slate-500">Format: minute hour day-of-month month day-of-week</p>
      </div>

      <!-- Quick Presets -->
      <div class="flex flex-wrap gap-2">
        <button type="button" onclick="setCron('0 2 * * *')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 transition-colors">
          Daily 2am
        </button>
        <button type="button" onclick="setCron('0 */6 * * *')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 transition-colors">
          Every 6h
        </button>
        <button type="button" onclick="setCron('0 9 * * 1-5')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 transition-colors">
          Weekdays 9am
        </button>
        <button type="button" onclick="setCron('0 0 * * 0')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 transition-colors">
          Weekly Sunday
        </button>
        <button type="button" onclick="setCron('0 0 1 * *')" class="px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-700 transition-colors">
          Monthly 1st
        </button>
      </div>

      <!-- Info: workspace from template -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-sm text-blue-700">
          <i class="fa-solid fa-info-circle mr-1"></i>
          Workspace will be automatically used from the selected template.
        </p>
      </div>

      <!-- Enabled -->
      <div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" name="enabled" id="enabled" {{ 'checked' if not schedule or schedule.enabled else '' }}
                 class="rounded border-slate-300 text-primary-600 focus:ring-primary-500">
          <span class="text-sm text-slate-700">Enable schedule</span>
        </label>
      </div>

      <!-- Submit -->
      <div class="pt-4 border-t border-slate-100 flex justify-end gap-3">
        <a href="/schedules" class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50">
          Cancel
        </a>
        <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors">
          <i class="fa-solid fa-save mr-2"></i>{{ 'Update' if schedule else 'Create' }} Schedule
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function setCron(expr) {
  document.getElementById('cron').value = expr;
  updateCronPreview();
}

function updateCronPreview() {
  const cron = document.getElementById('cron').value;
  const preview = document.getElementById('cronPreview');
  
  // Simple cron description
  const parts = cron.split(' ');
  if (parts.length === 5) {
    const [min, hour, dom, month, dow] = parts;
    let desc = 'Runs ';
    
    if (min === '0' && hour !== '*') {
      desc += `at ${hour}:00`;
    } else if (min !== '*' && hour !== '*') {
      desc += `at ${hour}:${min.padStart(2, '0')}`;
    } else if (hour.startsWith('*/')) {
      desc += `every ${hour.substring(2)} hours`;
    } else {
      desc += `(custom: ${cron})`;
    }
    
    if (dow === '1-5') desc += ' on weekdays';
    else if (dow === '0') desc += ' on Sundays';
    else if (dow === '6') desc += ' on Saturdays';
    else if (dom !== '*') desc += ` on day ${dom}`;
    
    preview.textContent = desc;
  } else {
    preview.textContent = 'Format: minute hour day-of-month month day-of-week';
  }
}

document.getElementById('cron').addEventListener('input', updateCronPreview);
updateCronPreview();

document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const scheduleId = '{{ schedule.id if schedule else "" }}';
  const isEdit = !!scheduleId;
  
  const payload = {
    name: formData.get('name'),
    template_id: formData.get('template_id'),
    cron: formData.get('cron'),
    enabled: formData.get('enabled') === 'on',
    config: {}
  };
  
  try {
    const url = isEdit ? `/api/schedules/${scheduleId}` : '/api/schedules';
    const method = isEdit ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    
    if (response.ok) {
      window.location.href = '/schedules';
    } else {
      alert('Failed to save schedule: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
});
</script>
{% endblock %}

